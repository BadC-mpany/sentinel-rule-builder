# Sentinel Policy Configuration
# Defines API key permissions, upstream servers, and security rules.

# --- Customer & API Key Definitions ---
customers:
  - api_key: "sk_live_demo_123"
    owner: "Demo User"
    # For Docker: use "http://mcp_server:9000"
    # For local development: use "http://localhost:9000"
    mcp_upstream_url: "http://localhost:9000"
    policy_name: "default_policy"

# --- Policy Definitions ---
policies:
  - name: "default_policy"
    # --- STATIC RULES (ACL) ---
    # Tools must be explicitly ALLOWED. Unlisted tools are implicitly DENIED.
    static_rules:
      read_file: ALLOW
      read_database: ALLOW
      web_search: ALLOW
      send_email: ALLOW
      get_weather: ALLOW
      create_temp_note: ALLOW
      anonymize_text: ALLOW
      redact_pii: ALLOW
      delete_db: DENY
      execute_shell_command: DENY

    # --- DYNAMIC RULES (Taint Logic) ---
    taint_rules:
      # Rule 1: Reading files adds 'sensitive_data' taint
      - tool: read_file
        action: ADD_TAINT
        tag: "sensitive_data"

      # Rule 2: Reading database adds 'sensitive_data' taint
      - tool: read_database
        action: ADD_TAINT
        tag: "sensitive_data"

      # Rule 3: Block CONSEQUENTIAL_WRITE tools if session has sensitive_data taint
      - tool_class: CONSEQUENTIAL_WRITE
        action: CHECK_TAINT
        forbidden_tags: ["sensitive_data"]
        error: "Exfiltration Blocked: Cannot use external communication tools after accessing sensitive data."

      # Rule 4: Sanitizers remove the sensitive_data taint
      - tool_class: SANITIZER
        action: REMOVE_TAINT
        tag: "sensitive_data"

      # Rule 5: Sequence pattern - block CONSEQUENTIAL_WRITE after SENSITIVE_READ
      - tool_class: CONSEQUENTIAL_WRITE
        pattern:
          type: sequence
          steps:
            - class: SENSITIVE_READ
            - class: CONSEQUENTIAL_WRITE
        action: BLOCK_SECOND
        error: "Security Policy: Direct exfiltration pattern detected (read sensitive â†’ external write)."

      # Rule 6: Logic pattern - block HUMAN_VERIFY tools after sensitive access
      - tool_class: HUMAN_VERIFY
        pattern:
          type: logic
          condition:
            AND:
              - session_has_class: SENSITIVE_READ
              - current_tool_class: HUMAN_VERIFY
        action: BLOCK_CURRENT
        error: "Security Policy: Cannot perform destructive operations after accessing sensitive data."

  - name: "read_only_policy"
    static_rules:
      read_file: ALLOW
      get_weather: ALLOW
      create_temp_note: ALLOW
      web_search: DENY
      send_email: DENY
      delete_db: DENY
      execute_shell_command: DENY
    taint_rules:
      - tool: read_file
        action: ADD_TAINT
        tag: "data_accessed"

  - name: "permissive_policy"
    # For testing - allows most operations
    static_rules:
      read_file: ALLOW
      read_database: ALLOW
      web_search: ALLOW
      send_email: ALLOW
      get_weather: ALLOW
      create_temp_note: ALLOW
      anonymize_text: ALLOW
      redact_pii: ALLOW
      delete_db: DENY
      execute_shell_command: DENY
    taint_rules:
      # Still track sensitive access
      - tool_class: SENSITIVE_READ
        action: ADD_TAINT
        tag: "sensitive_data"
      # But allow sanitizers to clear it
      - tool_class: SANITIZER
        action: REMOVE_TAINT
        tag: "sensitive_data"
